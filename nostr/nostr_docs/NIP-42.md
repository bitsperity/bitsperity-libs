# NIP-42: Authentication of Clients to Relays

## Meta
- **Status**: draft optional
- **Category**: Relay/Authentication
- **Required**: optional
- **Purpose**: Enables relays to authenticate clients and provide access control

## Summary
Defines challenge-response authentication mechanism for relays to verify client identities and provide access control.

## Core Concepts
- **Challenge-response**: Relay sends challenge, client responds with signed auth event
- **Kind 22242**: Authentication event signed by client
- **Access control**: Relays can restrict access based on authenticated identity
- **Optional authentication**: Clients can choose whether to authenticate

## Authentication Flow
1. **Client connects**: WebSocket connection established
2. **Relay challenge**: Relay sends AUTH message with challenge string
3. **Client response**: Client signs kind:22242 event and sends back
4. **Relay verification**: Relay verifies signature and grants access

## AUTH Message Format
**Relay to client**:
```json
["AUTH", "<challenge-string>"]
```
- **Challenge string**: Random string generated by relay
- **Unique per connection**: Each connection gets unique challenge

## Authentication Event (Kind 22242)
**Client response**:
```json
{
  "kind": 22242,
  "content": "",
  "tags": [
    ["relay", "wss://relay.example.com"],
    ["challenge", "<challenge-string>"]
  ],
  "created_at": 1677426236,
  "pubkey": "<client-pubkey>",
  "sig": "<signature>"
}
```

## Required Tags
- **relay**: WebSocket URL of the relay `["relay", "wss://..."]`
- **challenge**: Challenge string from relay `["challenge", "<string>"]`

## Client Behavior
- **Challenge response**: Respond to AUTH messages if willing to authenticate
- **Optional**: Clients may ignore AUTH challenges
- **Key management**: Use appropriate key for authentication
- **Connection state**: Track authentication state per relay

## Relay Behavior
- **Challenge generation**: Generate unique, unpredictable challenge strings
- **Signature verification**: Verify event signature and content matches
- **Access control**: Apply access rules based on authenticated pubkey
- **Graceful degradation**: Handle unauthenticated clients appropriately

## Use Cases
- **Private relays**: Restrict access to authenticated users only
- **Paid relays**: Authenticate users for billing/subscription verification
- **Rate limiting**: Apply different rate limits based on user identity
- **Content access**: Provide premium content to authenticated users
- **Admin functions**: Enable admin operations for authorized users

## Security Considerations
- **Challenge uniqueness**: Challenges must be unique and unpredictable
- **Replay protection**: Challenges should not be reusable
- **Connection binding**: Authentication tied to specific WebSocket connection
- **Key verification**: Verify that authentication key matches expected identity

## Access Control Examples
**Private relay**:
- Only allow connections from whitelist of pubkeys
- Reject all events from unauthenticated clients

**Freemium relay**:
- Allow limited access for unauthenticated clients
- Full access for authenticated subscribers

## Implementation Notes
- **Timing**: AUTH challenge typically sent immediately after connection
- **Retry logic**: Clients may retry authentication on failure
- **Connection lifecycle**: Authentication state per WebSocket connection
- **Error handling**: Graceful handling of authentication failures

## Error Responses
Relays may send NOTICE messages for authentication issues:
- `["NOTICE", "auth-required: authentication required"]`
- `["NOTICE", "invalid: authentication failed"]`
- `["NOTICE", "restricted: access denied"]`

## Optional Features
- **Token-based auth**: Some implementations may use bearer tokens
- **Multi-key auth**: Support for multiple authentication keys
- **Session persistence**: Maintain authenticated sessions across reconnections
- **Delegation**: Support for delegated authentication (see NIP-26)

## Related NIPs
- NIP-01 (basic event structure and signatures)
- NIP-11 (relay information document)
- NIP-26 (delegated event signing - alternative auth approach) 